# Рендеринг

будут интегральные уравнения (ухххх жесть)

на домашнее чтение было порекомендовано погуглить ключевое слово рендеринг и найти это уравнение

а также ссылочки на слайде 57

## Телесный угол

![[Pasted image 20250218134645.png]]

тут на картинке так-то все описано. только что радиан это величина безразмерная

по аналогии с плоскостью телесный угол образован лучами из центра окружности по границе некоторой области

мера определяется площадью этой области на квадрат радиуса

## Чуть чуть физики

примечания к следующему слайду

мощность и поток в рамках этого курса синонимы. измеряется в ваттах

облученность - отношение потока падающего на нек. площадку на площадь самой площадки. ватты/кв.метры

излучательность (ржачное слово) - отношение выходящего из площадки потока на площадь самой площадки

**энергетическая яркость** а вот сюда надо подетальнее посмотреть

отношение потока излучения, излучаемого площадкой, перпендикулярной направлению излучения к мере соответствущего телесного угла

в направлении омега на площадке перпендикулярной омега

если площадка не перпендикулярна, вводим коррекцию косинусом угла м/у нормалью поверхности и омега

смысл в том что при увеличении угла яркость уменьшается (спасибо кэп)

обозначения........

$i$ - падающее (входящее) излучение (incoming)
$o$ - исходящее излучение (outgoing)
$r$ - отраженное (reflected)
$e$ - излучение от источника (emitted)

таким образом $o = r+e$ и всо

если есть точка $x$ на сцене и направление (предполагаю что к камере), то входящая яркость в направлении омега будет равняться чему-то там в направлении -омега

## BRDF
Двулучевая функция отражательной способности
поверхности

ф-я описывает св-ва поверхности. как отражает свет. поскольку штука модельная, то должна быть как-то задана

рассматривается точка сцены. падает в нее излучение (свет). куда это излучение отразится и в каком кол-ве (отразиться может не всё)

поле вероятных направлений

короче то же рассеивание частиц только в другом контексте

вспоминаем что угол падения равен углу отражения, а также тот факт, что абсолютно гладких поверхностей не существует. подробнее опишу в разборе

**формальное определение**

![[Pasted image 20250218135830.png]]

зависит от точки сцены (не написано но подразумевается, очевидно имхо)

$$
f_r(x, \omega_i, \omega_o)
$$

падает излучение в направлении i

отношение отраженной энергетической яркости в направлении $\omega_0$ к облученности???? он не договорил

какая часть поступающего излучения отразится в направлении $\omega_o$

![[Pasted image 20250218140125.png]]

> формула ясна, идея понятна
> $\textcopyright$ Лукашенко

## Собсна уравнение рендеринга

все сводится к определению

если переписать

$$
dL_r = f_r \cdot dE_i
$$

и проинтегрировать по всем возможным направлением (полусфере) $H^2$ потому что hemisphere с 2мя параметрами (креатив 100)

$$
L_o = \int_{H^2}... + L_e
$$

$L_e$ - излучение порожденное источником тока (откуда он в рендеринге????? мы же свет смотрим?????? или уже в электромагнитные волны ударились?????)

короче вот

![[Pasted image 20250218140543.png]]

и не спрашивайте. самой переварить надо. суть ясна, а вот в формулах надо поковыряться

это уравнение потому что и слева и справа неизвестное $L_o$

Если посчитать $L_o$ в каждой точке и в каждом направлении, то будем знать всё про эту сцену

**BRDF может быть**

- константой (одинакова во всех направлениях). какая константа? смотрим

моделирует идеально рассеивающую поверхность. весь падающий свет отразился и в одинаковых направлениях с одинаковой вероятностью

технические выкладки неинтересны и спихиваются на нас

гхы 

пожелайте мне удачи

$$
L_r(x, \omega_o) = \int_{H^2} = f_r + \int_{H^2} L_i \cos \theta_i d\omega_i
$$

оставшийся интеграл это облученность

а если в яркости поставить какой-то из индексов и подменить куда-то числитель, то получится то, что надо и что-то там куда-то там

$$
E(x) = B(x)
$$

излучательность (поскольку всё отразилось)

$$
f_r E(x) = f_r B(x)
$$

и переписываем B через интеграл и по итогу индекс i подменится на r

не спрашивайте. просто дайте мне переварить эту чушь

в последней записи $\theta_r$  зависит от $\omega_r$

перейти к сферике, будет синус в якобиане и определенный интеграл по сферическим координатам. синус двойного угла, пределы от 0 до $\pi/2$ потому что полусфера и ещё что-то там куда-то там

начинали от одних буков пришли к другим и нихрена не видно

и отсюда делаем вывод, что 

$$
f_r = {1 \over \pi}
$$

обобщим

пусть отражение идеальное во всех направлениях, но уже есть поглощение. введем коэф-т отражательной способности поверхности

ну и слова. даль нервно курит в сторонке

$$
0 \leq \rho(x) \leq 1
$$

это альбедо (не из алхимии бтв) - коэф-т отражательной способности

```
возникает вопрос каким образом термин из средневековой алхимии перекочевал в _компьютерную графику_ of all places
```

при 0 полное поглощение, при 1 полное отражение

и как-то сюда прикручивается монте карло

упомянулась Dirac delta это ф-я которая не 0 титтк аргумент 0 (вроде так было)

другой пример

лепестки фонга (Phong)

всё сводится к косинусу м/у какими-то углами. я посмотрю поподробнее и опишу, тема инетерсная но _не так быстро мать вашу же ж_

вот то большое уравнение рендеринга решается через монте карло

рассмотрим частный случай - эффект ambient occlusion (модель окружающих препятствий)

смысл в чем - BRDF - константа (моделируется пасмурная погода) и всё сводится к взаимному расположению препятствий

значит аргумента омега там нет, он константа

это интеграл по полусфере и будет считать, что яркость падающего света определяется ф-ей видимости $V$

есть какое-то препятствие и пересекает/не пересекает. соответственно м.б. 0 (пересечения нет) или 1 (пересечение есть).

пусть ро одинаково во всех x -> выносится за интеграл

получили интеграл, надо рассчитать в каждой точке.

подынтегральная ф-я явно не задана, надо решать численно. можно конечно сократить область интегрирования не учитывая участки где видимость 0, но там не менее

в общем виде (любая размерность)

$$
\int_A f(x)dx
$$

надо свести к оценке мат ожиданий с.в.

Пусть $P(x)$ - плотность распределения некоторой с.в. $x \in A$

$$
\int_A
$$

че то с мат ожиданием от отношения f на p и надо осознать до конца

надо выбрать распределение. пусть равномерное

$$
{1 \over M(A)}
$$

и дальше что-то там куда-то там, куда??????

в этих выкладках A это полусфера. пусть равномерное распределение на полусфере. че-то поменять в формулах и получится равномерное на полусфере

в выкладках с прошлой лекции убирается из знаменателя 2 и вот оно счастье казалось бы но мы едем дальше

я очень сильно эту часть не поняла. не кидайтесь тапками плиз, мне и так плохо с этой темы

на слайде 66 итоговая оценка

и потом идут 2 картинки с шариками, там пример с объемом выборки. больший объем - больше вычислительные требования

рассматривается прямое освещение (direct illumination) - учитывается только излучение от источника света

расположение источников света на сцене задано

а значит в подынтегральной вместо $L_o$ будет $L_e$. и получим не уравнение а просто какой-то интеграл. чуть другой интеграл тоже по полусфере но как-то чем-то очень похож

![[Pasted image 20250218144919.png]]

берется ближайшая точка пересечения вектора $\omega_i$ со сценой

наблюдаем рекуррентный процесс. называется path tracing

рекомендую к просмотру видяшки про ray marching - там попобробнее про каст таких лучей. но это так, оффтоп от меня лично.

находим ближайшую точку и генерим направление на полусфере и идем в обратную сторону. сейчас может быть непонятно, потом распишу

и дальше оценка интеграла методом М-К

и это все можно интерпретировать в виде линейных операторов

ы

на вход искомое $L_o$. оператор $T_1(L)$ возвращает $L(r(x, \omega))$

$T_2$ это интеграл по полусфере плюс еще что-то

если $T$ скажем что суперпозиция 1 и 2, то получится что все можно записать в операторной форме

$$
L = L_e + T\circ L = L_e + T(T \circ L)
$$

причем $T$ линейный

и если это как-то разложить, то получится что-то вроде геометрической прогрессии

если в операторной форме то это ряд нейманна, а тут если норма оператора < 1 то что-то хорошее должно произойти с этой штукой

$$
L = (I-T)^{-1} \circ L_e
$$

очень сильно не поняла о чем речь. земля нам пуховиком

![[Pasted image 20250218145846.png]]

1. только источник света
2. то что отразилось 1 раз
3. то что отразилось 2 раза

опять он сказал про источник тока. как будто это внезапная оговорка, но я хз

конец первой лекции

## как убрать шум из картинок

НЕЙРОНКА!!! ВНЕЗАПНЫЙ ИИ!!!!1!1111!1!!!!!1

А если серьезно, то понижение дисперсии оценки.

# Методы понижения дисперсии оценок

Variance reduction methods в иностранной литературе

из первой лекции имеем СКО в доверительном интервале, из-за чего стремительно падает точность

не так важно мат ожидание конкретной с.в., как важна сама с.в. и надо взять такую, у которой дисперсия поменьше, чтобы ограничиться меньшим объемом

там кусок из самой первой лекции с доверительным интервалом, переписывать не буду даже в пережеванном тексте

## Относительная ошибка

она же коэф-т вариации оценки - отношение СКО к мат.ожиданию

![[Pasted image 20250218152909.png|300]]

разброс относительно среднего

пример с выборками 1 2 3 и 10е-2, 10е-6 и 10е-8

## Метод дополнительных (дополняющих) случайных величин

antithetic variables

идея - выборка по определению независимая реализация с.в. а можно ввести зависимость, но так чтобы итог дисперсия стала меньше

дисперсия среднего двух с.в. это четверть сумм дисперсий + 2 ковариации

а если эти величины отрицательно коррелированы, то их дисперсия среднего будет меньше

что и требуется получить

если метод обратной ф-и, то подстановка реализация

в этом примере

![[Pasted image 20250218153446.png]]

обе с.в. зависимы от u и их ковариация $-1/12$

из тервера имеем

![[Pasted image 20250218153533.png]]

характер монотонности не важен

как будто бы это обобщение примера, но не факт

то есть если мы возьмем такую базу, то дисперсия в худшем случае останется неизменной, а скорее всего уменьшится

> тут игрушечный пример, всё просто
> $\textcopyright$ Лукашенко

тем временем игрушечный пример:

![[Pasted image 20250218153806.png]]

ueeueueuueuue гхы

![[Pasted image 20250218154916.png|200]]

метод применим, когда ф-я монотонна. иначе может возникнуть положительная корреляция и дисперсия увеличится

## метод контрольных случайных величин

control variate

Пусть надо оценить $E(X)$ И пусть есть $Y$ - вспомогательная с.в. с мат ожиданием $\mu$

$$Z = X + c(Y-\mu)$$

мат ожидания совпадают, а вот дисперсия

![[Pasted image 20250218154503.png]]

подберем константу $c$ так чтобы дисперсия уменьшилась

100500 лет матанализа спустя

![[Pasted image 20250218154543.png|300]]

а вот это 

![[Pasted image 20250218154621.png]]

типа домашка. проверить посчитать убедиться

этот метод никогда не увеличит дисперсию. в худшем случае корреляция 0 и дисперсия останется. чем больше зависимость, тем меньше будет дисперсия $Z$ по $X$

сгенерив выборки можно найти соответствующие оценки и предположить обе дисперсии

есть связь с линейной регрессионной моделью но это типа не важно. поверим наслово......

## условный метод М-К

или метод условных мат. ожиданий

похож на контрольных с.в. только надо иметь с.в. такую чтобы условное $E[X|_Y]$ было известно в явном виде

под записью условного мат ожидания подразумевается $E[X|_{Y=y}]$. тогда было бы событие и мат ожидание было бы некоторой функцией от $y$ а там его нет, поэтому там просто с.в. и соответственно тоже с.в.

![[Pasted image 20250218155351.png]]

идея - вместо оценки $E(X)$ оценим $E(Z)$. выборочное среднее по $Z$. генерятся выборки вспомогательного распределения

дисперсия будет не хуже по св-ву условной дисперсии

как запомнить

дисперсия X это сумма которая отличается порядком мат ожидания и дисперсии. при этом слева исходная, справа дисперсия $Z$ и $DX$ отличается $DZ$ на положительное слагаемое - то есть всегда больше.

## метод существенной выборки

importance sampling

![[Pasted image 20250218160542.png]]

интеграл по определению мат ожидания. интегрируется по области определения с.в. (очевидно но стоит записать, и так логика запутанная)

введем вспомогательную плотность распределения $g(x)$ и скажем что

индекс $f$ - расрпеделение относительно кот. считается мат ожидание

домножим и разделим на плотность $g$ и перепишем мат ожидание относительно его же

тогда вместо $f$ будем генерить $g$ и оценивать его

> Все идеи просты так-то
> $\textcopyright$ Лукашенко

и то и то это несмещенные оценки мат. ожиданий, поэтому хотелось бы уменьшить дисперсию $h {f \over g}$

если нехорошо выбрать $g$, то дисперсия будет больше

из здравого смысла: как выбираем $g$??

вспомним что

$$
\int_A f(x)dx
$$

не обязательно равномерное распределение

пусть есть какое-то похожее на нормальное на отрезке $[A,B]$ 

больший вклад в интеграл вносят точки где ф-я больше. значит поставим этот максимум туда, где точки имеют бОльшее значение.

и drawback к этому это отношение плотностей

![[Pasted image 20250218161320.png|450]]

это отношение правдоподобися

мат ожидание чего-то там 1

че-то пропускаем типа и так все понятно

_но нихера не понятно_

логично выбирать плотность, чтобы оцениваемое событие наступало чаще. а можно ли найти оптимальное вспомогательное распределени, которое даст самую минимальную дисперсию? так вот, да. но нам от этого ни холодно ни жарко

тем не менее вот

![[Pasted image 20250218161556.png]]

знаменатель - нормировочная константа (шоб интеграл был 1)

это нереализуемо, потому что знаменатель зависит от той же характеристики и типа не можем его посчитать????

если $h$ положительна, то дисперсия 0

мат ожидания совпадают, можно сравнить начальные моменты 2 порядка. 

![[Pasted image 20250218161857.png]]

сравнили сказали что все ок. че-то там выводится в константу, а я уже никуда не вывожусь. куда-то интегралы, че-то раскладывается в интегралы, куда-то преобразуется, спасите жертву матанализа

$$
(EX)^2 \leq EX^2
$$

после этой записи аудитория многозначительно хмыкнула

вспомним что нормировочная константа это константа. приблизим нормальное распределение к искомому $g^*$

найти максимум оптимизировав числитель и игнорируя константу (как?) и подогнав какое-либо распределение под моду или мат ожидание

а раз исходное идеально, то приближенное будет чуть менее идеальное но тоже достаточно хорошее

$$
D(g_y || g)
$$

оценка по метрике распределения - расстояние кого-то там часто в машинном обучении фигурирует мат ожидание логарифма отношений искомого и кросс энтропии

думаю этого достаточно для гуглинга

$g$ - какое-то параметрическое распределение и минимизируется функционал

игрушечный пример - взвешенный вар-т существенной выборки

вот эта хрень

![[Pasted image 20250218162956.png|130]]

значит известно с точностью до константы

и это был почти весь 1 раздел................