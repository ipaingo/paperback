_Сначала идет лирическое отступление на тему применения гауссовских процессов, кому интересно смотрим в записи с лекций_

# Моделирование марковских цепей

> [!success] Дано:
> - Цепь Маркова с дискретным временем и конечным пространством состояний $E$:  $\{X_n, n \in \mathbb{N}\}$
> - Начальное распределение $P^0 = (p_1^0, ..., p_n^0)$
> - Матрица переходных вероятностей $P = ||p_{ij}||_{i,j \in E}$

> [!question] Найти
> Как сгенерить экземпляры такой цепи

1. Генерируем начальное состояние (оно же ДСВ - пространство состояний конечно, а значит, отобразимо на ДСВ)
2. Переход в следующее состояние генерируется по матрице переходных вероятностей: в $i$-й строке содержатся вероятности уйти из $i$-го состояния в какое-либо другое.
3. Генерация перехода повторяется сколько нужно - получается траектория процесса.

_и по этой теме всё_

# Моделирование изотропного вектора
Случайный вектор называется ==изотропным==, если он распределен равномерно на некоторой области

## На окружности
На лекции начинали с 2х-мерного случая, посмотрим и здесь. Надо сгенерить равномерное распределение на единичной окружности. Логично представить эту окружность в полярных координатах и взять угол $\varphi$ по $\mathfrak{U}(0, 2\pi)$

![[Pasted image 20250214170137.png|350]]

постепенно преисполняюсь в десмосе

Взяли мы угол равномерно, сделали так:

$$
x = \cos\varphi \quad y = \sin\varphi
$$

И радуемся тому, как всё просто.

_Порадовались? А теперь погрустим_

## На сфере
Если мы вспомним компьютерную графику, то заметим одно интереснейшее совпадение - при переходе из плоскости на пространство $\mathbb{R}^3$ всё ломается. Но это не более, чем совпадение, потому что там мы имели дело с умножением вполне себе конкретных кватернионов, а тут мы по сути искривляем 2х-мерную Евклидову геометрию до некоторого подобия сферической. Но это так, авторские рассуждения.

Итак, имеем единичную сферу, ~~декартовы~~ координаты и задачу генерации изотропного вектора на этой сфере в декартовых координатах.

Самые ушлые могут вспомнить 2 аналога полярных координат в $\mathbb{R}^3$ - сферические и цилиндрические координаты. Первые задаются тройкой $(r, \varphi, \theta)$ - радиус и 2 угла, а вторые - тройкой $(\rho, \varphi, z)$ - радиус, угол поворота и аппликата.

Первым нашим инстинктом станет равномерное распределение обоих углов, но _нет_. Если мы так сделаем, то будем наблюдать смещение в сторону оси $z$.

Я очень хотела нарисовать сферу и раскрасить её градиентом в тепловую карту плотности такого распределения, но у меня сейчас нет пакетов, которые такое бы сделали, поэтому пока что без картинки. Представили жопку воздушного шарика? Вот такое примерно смещение. Возможно когда нибудь в следующей жизни я это нарисую, но не сейчас.

Окей, 2 угла мы не можем раскидать равномерно. Найдем, как их кинуть, чтобы получилось то, что надо:

![[Pasted image 20250211142506.png]]

Я проиграла десмосу поэтому получите пикчу из инета. На удивление углы в выкладках с презентахи соответствуют тем, что указаны здесь, с одной лишь разницей - $\varphi$ это $\phi$ которое на картинке 

```
и почему все так любят букву фи которая пишется как \varphi, это же по 3 лишние буквы на каждую букву
```

Обратимся к геометрии и посчитаем площади всякие разные, чтобы оценить вероятность попадания некоторой точки $A$ в некоторый кусок сферы. Из школьного курса геометрии имеем

$$
S_{\text{сферы}} = 4\pi
$$

А вот с сегментом всё не так просто, ибо тут уже нужно подключить матанализ. Возьмем некоторую точку на сфере и зафиксируем приращения к ней по обоим углам

![[Pasted image 20250217143041.png]]

```
Дополнительных линий не будет, потому что 3д десмос тупой как пробка, зато красивый. Живите с этим. Или не живите, я потихоньку осваиваю Octave, вдруг лучше будет.
```

Посчитаем как эти приращения влияют на площадь этого маленького кусочка сферы

Поскольку кусочек сферы _маленький_, то по свойству производных (теорема о среднем??) можно приравнять его к прямоугольнику, построенному на касательной плоскости из точки, откуда идут приращения, в сторону приращения. Иначе говоря, множим кривизну на ноль и рассматриваем плоскую проекцию, ибо при выведении приращений в ноль эти площади один хрен сравняются.

Итак, рассмотрим стороны этого прямоугольника, а именно длины дуг на границах кусочка сферы.

Если мы фиксируем $\varphi$ и двигаем $\theta$ (напоминаю, это угол плоскости, проходящей через ось $z$), то длина дуги, прочерченной таким "циркулем" будет $r\theta$ или же просто $\theta$, поскольку сфера единичная

А с $\varphi$ всё прикольнее. Там площадь меняется не просто в зависимости от угла, но ещё и от его синуса. Почему? А тригонометрия 7 класса, вот почему

![[Pasted image 20250218122833.png|300]]

Надеюсь, дальнейших объяснений не требуется. Энивей, $r\varphi\sin\varphi$. Всё перемножаем, получаем 

$$
S(d\Omega) = \sin\varphi\ d\varphi \ d\theta
$$

А значит по геометрическому определению вероятности со 2 курса:

$$
\mathbb{P}(A \in d\Omega) = \frac{\sin\varphi\ d\varphi\ d\theta}{4\pi}
$$

Вспомним замечательное свойство функций распределения из 1 части тервера, а именно (по-Роговски):

$$
\mathbb{P}(x_1\leq\xi\leq x_2) = F_\xi(x_2) - F_\xi(x_1) = \int_{x_1}^{x_2} P_\xi(x)\ dx
$$

А также (несколько видоизмененную) теорему о среднем с 1 курса матана:

$$
\int_{x}^{x+\Delta x} f(t)\ dt ≈ f(x) \Delta x
$$

И сделаем нехитрый вывод о том, что в вышестоящее примерно равенство можно подставить

$$
\iint_{d\Omega} P(\varphi, \theta) \ d\varphi\ d\theta ≈ P(\varphi, \theta) \ d\varphi\ d\theta
$$

_Это очень смешно, но $d\varphi$ и $d\theta$ слева это не те же самые $d\varphi$ и $d\theta$, которые справа. В первом случае это просто переменные интегрирования, а во втором это кусочки приращения. Да и $d\Omega$ тут чисто с целью заявить, что считается площадь именно куска сферы (а не **от** куска сферы, ибо это не имеет смысла строго говоря). Короче условность и не более, формально записывать длинно и не хочу, вряд ли спросят, а вам так виднее весь этот абсурд <3_

При выведении всех этих приращений в ноль примерно равенство (внезапно) станет равенством, и мы со спокойной совестью сможем заявить, что:

$$
P(\varphi, \theta) = {\sin\varphi \over 4\pi}
$$

```
и как спрашивается препод предполагает, что мы помним _вот это вот всё_ и прям сходу можем сообразить что и как и куда зачем каким образом........
```

Нашли совместную плотность, ищем маргинальные (а тут и я напоминать не буду, видели уже всё тыщу раз)

$$
P_\varphi = {\sin\varphi \over 2}
$$

$$
P_\theta = {1 \over 2\pi}
$$

И по (опять же) объясненным ранее формулам:

$$
\theta \sim \mathfrak{U}(0,2\pi) \quad F_\varphi = {1-\cos\varphi \over 2}
$$

И по методу обратной функции:

$$
\varphi = \arccos (1-2u)
$$

Откуда делаем вывод (взяв косинус от аркосинуса), что не угол должен быть раскидан равномерно, а его косинус на $\mathfrak{U}(-1,1)$

### Альтернативный способ генерации

> Пусть $X, Y, Z$ - независимы и распределены по $\mathbb{N}(0,1)$. Тогда случайный вектор $(X,Y,Z)$ изотропный

Иначе говоря, берем генерим 3 числа по $\mathbb{N}(0,1)$ (что было разобрано на прошлой лекции), склеиваем из них вектор и получаем, что он внезапно изотропен. Никаких косинусов и сферических координат. Просто изотропен.

Хотя я вам наврала. Сферика будет, но только в выводе.

_И ещё один момент. В условии то ли неточность, то ли очередной logical leap длиною в пару световых лет, но вектор $(X,Y,Z)$ на самом деле раскидан не по сфере, а по всему пространству. Все его компоненты раскиданы по $\mathbb{R}$ без какой-либо привязке к сфере, а значит их надо бы нормировать. Но об этом далее._

Переведем совместную плотность в сферические координаты

$$
P(r,\varphi,\theta) = {1 \over 2\pi^{3/2}} e^{-r^2/2}\ r^2 \sin\varphi
$$

И пронормируем эти вектора, сделав их независимыми от радиуса

$$
P(\varphi,\theta) = \int_0^{\infty} P(r,\varphi,\theta) dr = {\sin\varphi \over 4\pi}
$$

Как мы это получили? Один матанализ знает. Я поверю наслово презентации, кто не верит, вспоминаем матан.

Получили то же самое, что и в прошлом пункте, а значит направления раскиданы равномерно. Поделим каждый вектор на его длину, получим, что они все легли равномерно на единичную сферу

## На произвольной кривой в пространстве
> [!success] Дано
> Кривая $l$ задана параметрически в $\mathbb{R}^3$:
> $$
\begin{cases}
x = x(t) \\
y = y(t) & \quad t \in [t_0,t_1] \\
z = z(t)
\end{cases} $$

> [!question] Найти
> Как раскидать параметр $t$, чтобы при отображении на кривую точки были раскинуты равномерно

Сделаем аналогично со сферой и посчитаем геометрически длину к длине

Из курса матанализа вспоминаем длину параметрически заданной кривой

$$
|l| = \int_{t_0}^{t_1} \sqrt{\big(x^\prime(t)\big)^2 + \big(y^\prime(t)\big)^2 + \big(z^\prime(t)\big)^2} dt
$$

А также то, что длина микрокусочка такой кривой будет примерно равна длине микрохорды, стягивающей его границы и это примерно равенство выходит в равенство при занулении приращений (камон, это сама сущность интегралов)

$$
|dl| ≈ \sqrt{\big(x^\prime(t)\big)^2 + \big(y^\prime(t)\big)^2 + \big(z^\prime(t)\big)^2} dt
$$

А значит по геометрической вероятности: 

$$
\mathbb{P}(A \in dl) = {dl \over l} = \frac{\sqrt{\big(x^\prime(t)\big)^2 + \big(y^\prime(t)\big)^2 + \big(z^\prime(t)\big)^2} dt}{\underset{t_0}{\overset{t_1}{\int}} \sqrt{\big(x^\prime(t)\big)^2 + \big(y^\prime(t)\big)^2 + \big(z^\prime(t)\big)^2} dt}
$$

И вот эта штука и будет плотностью распределения параметра $P(t)$. Так же, как и в прошлом пункте убираем $dt$ и получаем искомое.

> Примечание: если кривая это прямая, то за распределение параметра можно взять например, равномерно раскиданную абсциссу
> $$ x=t \quad y=y(x) \quad z=z(x) $$

## На произвольной поверхности

Перенесем на поверхность ситуацию с кривой.

$$
\begin{cases}
x=x(u,v) \\
y=y(u,v) & \quad (u,v) \in D \\
z=z(u,v)
\end{cases}
$$

```
почему в презентации написано, что точка это подмножество области? то ли лыжи не едут, то ли я......
```

Пример со сферой это ни что иное, как частный случай этого пункта

По аналогии с кривой посчитаем геометрически вероятность попасть в кусочек поверхности, сказав, что $D$ - это область определения параметров, а $S$ - это рассматриваемая поверхность

$$
\mathbb{P}(A \in dS) = \frac{\sqrt{EG-F^2}\ dudv}{\underset{D}{\iint}\sqrt{EG-F^2}\ dudv}
$$

Что это такое, спросите вы? И я отправлю вас в дебри под названием "Записи с лекций" и во второй вроде бы семестр матанализа, где рассматривались двойные и поверхностные интегралы.

### Например на поверхности тора

(не из марвел)

Проще говоря, пончик, полученный вращением круга вокруг оси как будто бы $z$, но я не уверена. Энивей

$$
\begin{cases}
x = (R+r\cos u) \cos v \\
y = (R+r\cos u) \sin v & \quad u \in [0,2\pi], v \in [0,2\pi]\\
z = r \sin u
\end{cases}
$$

где $R$ - радиус большого кольца, а $r$ - радиус маленького кружочка

_я тут [демку](https://www.desmos.com/calculator/5ebupgc9d5) накидала с сечением тора в разных плоскостях. все радиусы двигаются, в 3д делать не стала из-за тупости 3д десмоса_

```
а ещё там нельзя просто так взять и написать R - r' <= r <= R + r' в полярных координатах
```

> Дифференцируй не хочу. И не буду на лекции. Технические выкладки за вами
> $\textcopyright$ Лукашенко

и не за мной точно. мне не платят за количество формул в конспектах

100500 лет матанализа спустя мы получим, что

$$
v \sim \mathfrak{U}(0, 2\pi)
$$

_судя по описанию поверхности это угол вращения маленького кружочка и он может быть равномерно раскинут, т.к. площадь кусочка такого пончика не зависит от абсолютного значения угла, а только от того, насколько он поменялся_

$$
P(u) = \frac{Rr + r^2\cos u}{2\pi Rr}
$$

Вот эта штука, если верить моим нефильтрованным мыслям с лекций, будет полезна в следующей лабе

# Моделирование процесса переноса частиц

эта шутка слишком запала мне в душу

> [!success] Дано:
> - Кукуха (летит)
> - Некоторое метафоричное препятствие на пути кукухи - артефакт оптически непрозрачной среды

> [!question] Сгенерить
> Направление, куда полетит кукуха при рассеивании частиц

А если серьезно, то летела частица, ~~упала в болото, какая зарплата, такая работа~~ кхъ

А если прям совсем совсем серьёзно, то рассмотрим, например, фотоны. Все помнят про преломление света из общего курса физики? И про то, что существует такой коэффициент преломления, который зависит от среды, в которую пустили свет? Вот тут происходит нечто похожее, только с небольшими отличиями, а именно:

- Перемещение фотонов происходит в однородной оптически непрозрачной среде
- Траектория фотонов меняется как будто бы случайным образом (в школьной физике рассматривался один фотон, который ровной линией идет через среду, что является достаточно грубым, но значительно упрощающим вычисления модельным допущением)

_вот кстати это как будто бы случайным образом - оно по сути тоже модельное допущение, но чуть более приближенное к irl. мне выложить мои рассуждения на эту тему или никому не интересно?_

Иначе говоря, имеем частичку, которая движется в некоторой однородной оптически непрозрачной среде и которая время от времени сталкивается с артефактами этой среды (помехами/препятствиями/называйте как хотите). В результате чего возможны 2 исхода:

- __Рассеивание__ (частица изменила направление)
- __Поглощение__ (частица прекратила движение, траектория больше не отслеживается)

В связи с этим вводится ещё одно понятие - ==длина свободного пробега== - расстояние, пройденное частицей м/у двумя такими столкновениями. Зависит от параметров среды, чем более оптически прозрачную среду мы имеем, тем больше длина свободного пробега и наоборот. На лекции было ещё что-то про экспоненциальное распределение, но вряд ли это настолько важно.

И наконец, получаем полную формулировку задачи - найти вероятность поглощения частицы, а также плотность распределения рассеивания.

Иными словами - с какой вероятностью частица поменяет направление, а не остановится, и с какими вероятностями она полетит под разными углами.

![[Pasted image 20250211155558.png]]

Вот на этой пикче с презентахи имхо очень понятно нарисовано что и как и куда. Введем точку $(x_0, y_0, z_0)$ - точку столкновения, а также $\varphi$ и $\theta$ - углы, однозначно определяющие $V$ - направление рассеивания

Имеет место _аксиальная_ симметрия (относительно оси предыдущей траектории)

Очень сильно вся эта картина попахивает ранее рассмотренным изотропным рассеиванием по сфере. И действительно, изотропное рассеивание - это частный случай _анизотропного_ (неравномерного)

В связи с этим, вспомним, что в том рассеивании $\varphi$ и $\cos\theta$ раскиданы равномерно (буквы поменялись местами, суть осталась). Положим, что $\varphi$ так же раскидан равномерно (по всей окружности справа вероятность одинакова), а $\cos\theta$ раскидаем так:

$$
P_{\cos\theta}(x) = \frac{1-g^2}{2(1+g^2-2gx)^{3/2}}, \quad x \in [-1,1]
$$

В этой формуле $g \in [-1,1]$ - ==коэффициент анизотропии== - насколько сильно плотность рассеивания смещена в сторону исходного вектора. Как жопка у воздушного шарика

_Если $g=0$, то получим плотность $1/2$, что соответствует $\mathfrak{U}[-1,1]$ при изотропном рассеивании_

Плотность _косинуса_, а не самого угла. Прописала везде, но всё-таки стоит отдельно об этом сказать

В презенташке есть крайне занимательные рисунки

![[Pasted image 20250211160911.png]]

Это фазовая функция Хени-Гринштейна, а точнее 3 её экземпляра для разных коэффициентов анизотропии, и понимать её так. Берем точку на кривой, считаем длину вектора туда из начала координат. Эта длина будет плотностью рассеивания в данном направлении.

Короче, чем дальше от $(0,0)$, тем вероятнее туда полететь ~~кукухой~~ кхъ

В общем и целом, знаем исходное направление $V$, углы $\varphi$ и $\theta$, хотим узнать новое направление $V^\prime$. Делаем _страшные буквы_

$$
\begin{cases}
V_x^\prime = V_x\cos\theta + {\sin\theta \over \sqrt{1-V_z^2}} (V_x V_z \cos\varphi - V_y\sin\varphi) \\
V_y^\prime = V_y\cos\theta + {\sin\theta \over \sqrt{1-V_z^2}} (V_y V_z \cos\varphi - V_x\sin\varphi) \\
V_z^\prime = V_z\cos\theta - \sin\theta\cos\varphi \sqrt{1-V_z^2}
\end{cases}
$$
Это ^^^ если $|V_z| \neq 1$
$$
\begin{cases}
V_x^\prime = \sin\theta\cos\varphi \\
V_y^\prime = \sin\theta\sin\phi \\
V_z^\prime = V_z \cos\theta
\end{cases}
$$

А это ^^^ если $|V_z| = 1$

_И тут как будто бы нюанс: в презентахе указано в последнем выражении домножить на знак $V_z$, но поскольку он по модулю 1, то не значит ли это, что $V_z$ по-любому $\pm 1$ и ничего более? То есть смысл домножать только на знак, когда абсолютное значение и так 1?_

Объяснять не буду, ибо лень матушка

# ИМ движения фотонов в многослойных средах

Вот всё вышерассмотренное переносится на несколько слоев таких однородных сред

У каждого такого слоя есть набор параметров $(\mu_{a_i}, \mu_{s_i}, g_i, d_i)$, где
- $\mu_{a_i}$ - коэф-т поглощения
- $\mu_{s_i}$ - коэф-т рассеяния (так-то рассеивания, но пусть. великий и могучий нервно курит в сторонке и лингвисты вместе с ним)
- $g_i$ - коэф-т анизотропии
- $d_i$ - толщина слоя

Длина свободного пробега фотона распределена экспоненциально с параметром $\mu_i = \mu_{a_i} + \mu_{s_i}$

Каждый фотон инициализируется в начале координат с определенным весом $W_0$. Определяется начальный вектор его движения

Вероятность поглощения фотона при столкновении определяется как $P_{a_i} = {\mu_{a_i} \over \mu_{a_i} + \mu_{s_i}}$

Направление движения фотона задается парой углов $(\theta, \varphi)$, распределение которых задается фазовой функцией (см. выше)

При каждом взаимодействии со средой вес фотона уменьшается на

$$
\Delta W = W {\mu_{a_i} \over \mu_i}
$$

А теперь немножко не по слайдам

У каждого фотона есть некоторое пороговое значение веса, достигнув которого, он _буквально начинает играть в русскую рулетку (если верить Лукашенко, то и в источниках так пишут)_

**Q: Что при этом происходит?**

**A:** Фотон может:
- С вероятностью $1/m$ продолжить движение, поменяв массу до $mW$ 
- С обратной вероятностью считаться поглощенным при текущем столкновении

**Q: Зачем это нужно?**

**A:** Чтобы фотоны генерили больше информации без потери точности генерации. 

**Q: ЧЗХ???**

**A:** Разумного объяснения у меня на этот счет нет, только математическое, и то не совсем понятное. Тем не менее, получите распишитесь

Для каждого фотона имеем следующее:

$$
X^\prime = \begin{cases}
\frac{1}{p}X, & \quad \mathbb{P} = p \\
0, & \quad \text{иначе}
\end{cases}
$$

Не спрашивайте, кто это такое и с чем его едят. Важно, что если мы посчитаем мат. ожидание такого экземпляра, то оно будет равно исходному, а значит по какой-то неведомой нам причине мы можем получить больше данных из фотона, никак при этом не влияя на результаты

```
окей гугл как описывать сложный для осознавания предмет с юмором чтобы не было так скучно это все читать если все шутки в твоем арсенале это пошлый казарменный юмор и стеб уровня american grrrrl vibes
```

```
если кто до этого места дочитал, фидбэкните плиз, есть ли мне смысл дальше перекапывать это все для народа или нахрен оно надо и я зря стараюсь?
```